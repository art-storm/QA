node {

    def imagename = "igorunnamed/test-app-java"
    def registryProvider = 'http://registrydockerimages.azurecr.io'
    def registryCredential = 'docker_hub'
    def dockerImage = ''

    stage('Clone sources') {
        git url: 'https://github.com/art-storm/QA.git'
    }

    stage('Build') {
        sh 'mvn -B -DskipTests clean package'
    }

    stage('Test') {
        sh 'mvn test'
        junit '**/test-results/test/*.xml'
    }

    stage('Building image') {
        dockerImage = docker.build imagename
    }

    stage('Push image') {
        if (env.PUSH_TO_REGISTRY == 'true') {
            docker.withRegistry('', registryCredential) {
                dockerImage.push("${env.GIT_COMMIT}")
                dockerImage.push("latest")
            }
        } else {
            echo "Docker image wasn't pushed"
        }
    }

}