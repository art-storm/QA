node {

    def imagename = "registrydockerimages/test-app-java"
    def registryProvider = 'http://registrydockerimages.azurecr.io'
    def registryCredential = 'azure-container-registry'
    def dockerImage = ''

    stage('Clone sources') {
        git branch: 'master', url: 'https://github.com/art-storm/QA.git'
    }

    stage('Build') {
        sh 'mvn -B -DskipTests clean package'
    }

    stage('Test') {
        sh 'mvn test'
        junit 'target/surefire-reports/*.xml'
    }

    stage('Building image') {
        dockerImage = docker.build imagename
    }

    stage('Push image') {
        if (env.PUSH_TO_REGISTRY == 'true') {
            commitId = sh(returnStdout: true, script: 'git rev-parse HEAD')

            docker.withRegistry(registryProvider, registryCredential) {
                dockerImage.push("${commitId}")
                dockerImage.push("latest")
            }
        } else {
            echo "Docker image wasn't pushed"
        }
    }

    stage('Cleaning up') {
        sh "docker images | grep '$imagename' | awk '{print \$3}' | xargs docker rmi -f"
    }

}