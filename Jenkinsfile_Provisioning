pipeline {
    agent any
    tools {
        terraform 'terraform-1.0.6'
    }

    stages {
        stage('Git Checkout') {
            steps {
                git branch: 'master', url: 'https://github.com/art-storm/QA.git'
            }
        }

        stage('Terraform init') {
            steps {
                withCredentials([azureServicePrincipal('azure-service-principle')]) {
                    sh '''
                        az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET -t $AZURE_TENANT_ID
                        cd ./terraform && terraform init
                    '''
                }
            }
        }

        stage('Terraform apply') {
            steps {
                sh 'cd ./terraform && terraform apply --auto-approve'
            }
        }

    }

}